name: Fallout Bunker CI Pipeline

on:
  workflow_dispatch:      
  push:
    branches: [ main ]    
  pull_request:
    branches: [ main ]

jobs:
  full-stack-test:
    runs-on: ubuntu-latest

    steps:
    # --- 1. SETUP ---
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # --- 2. BACKEND UNIT & INTEGRATION TESTS (MSTest) ---
    - name: Restore Backend Tests
      run: dotnet restore ./Tests/Backend/IDeviceTests/IDeviceTests.csproj

    - name: Run Backend MSTest
      # Runs logic tests in memory. Does NOT need the API running.
      run: dotnet test ./Tests/Backend/IDeviceTests/IDeviceTests.csproj --configuration Release -- -parallel:none

    # --- 3. PREPARE & START API ---
    
    # [NEW STEP] Clean up any files left over by MSTest so API starts fresh
    - name: Clean Sensor Data
      run: rm -rf ./backend/FalloutBunkerManager/SensorEmulationFiles

    - name: Start Backend API (Background)
      run: |
        echo "Starting .NET API..."
        # Start API in background on port 5000
        nohup dotnet run --project ./backend/FalloutBunkerManager/FalloutBunkerManager.csproj --urls "http://localhost:5000" > api.log 2>&1 &
        sleep 10 # Give it time to boot up and create default files
        cat api.log

    # --- 4. START FRONTEND ---
    - name: Install Frontend Dependencies
      run: npm install
      working-directory: ./frontend

    - name: Start Frontend Web (Background)
      run: |
        echo "Starting Expo Web..."
        cd frontend
        # Start web server on port 8081
        nohup npx expo start --web --port 8081 > frontend.log 2>&1 &
        sleep 15
        cat frontend.log

    # --- 5. PLAYWRIGHT UI SYSTEM TESTS ---
    - name: Install Playwright Dependencies
      working-directory: ./Tests/UI
      run: npm install

    - name: Install Playwright Browsers
      working-directory: ./Tests/UI
      run: npx playwright install --with-deps

    - name: Run Playwright System Tests
      working-directory: ./Tests/UI
      run: npx playwright test
      env:
        CI: true
