name: Sprint-1-tests

on:
  workflow_dispatch:      
  push:
    branches: [ main ]    
jobs:
  scada-pipeline:
    runs-on: ubuntu-latest

    steps:
  
    - name: Checkout code
      uses: actions/checkout@v3

    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'


    - name: Restore Test Project
      run: dotnet restore ./Tests/Backend/IDeviceTests/IDeviceTests.csproj

    - name: Build Test Project
      run: dotnet build ./Tests/Backend/IDeviceTests/IDeviceTests.csproj --configuration Release

    - name: Run MSTest Unit Tests (Level 1)
      run: dotnet test ./Tests/Backend/IDeviceTests/IDeviceTests.csproj --configuration Release --no-build


    - name: Restore API Project
      run: dotnet restore ./backend/FalloutBunkerApi/FalloutBunkerApi.csproj

    - name: Build API Project
      run: dotnet build ./backend/FalloutBunkerApi/FalloutBunkerApi.csproj --configuration Release

    - name: Start API in background (Level 2)
      run: |
        echo "Starting ASP.NET Core API..."
        dotnet run --project ./backend/FalloutBunkerApi/FalloutBunkerApi.csproj &
        sleep 10   # give API time to start


    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Node Dependencies
      run: npm install
      working-directory: ./Tests/Backend

    - name: Run Level 2 Device API Tests
      run: node poll-devices.mjs
      working-directory: ./Tests/Backend

    - name: Run Level 3 Playwright UI Tests (placeholder)
      run: echo "Playwright tests will be added in Sprint 2"
